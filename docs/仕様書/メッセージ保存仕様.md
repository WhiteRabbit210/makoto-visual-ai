# メッセージ保存仕様

## 目次
1. [概要](#概要)
2. [保存ポリシー](#保存ポリシー)
3. [ストレージ構成](#ストレージ構成)
4. [ディレクトリ構造](#ディレクトリ構造)
5. [メッセージデータ形式](#メッセージデータ形式)
6. [ファイル保存仕様](#ファイル保存仕様)
7. [実装例](#実装例)
8. [取得方法](#取得方法)

## 概要

MAKOTO Visual AIのメッセージ保存仕様を定義します。全てのメッセージはサイズに関わらずBlobStorage/S3に保存されます。

## 保存ポリシー

### ⚠️⚠️⚠️ 重要：全メッセージBlobStorage/S3保存 ⚠️⚠️⚠️

**全てのメッセージはサイズに関わらずBlobStorage/S3に保存します！！！**

- ✅ **正しい実装**: 小さいメッセージも含めて全てBlobStorage/S3に保存
- ❌ **間違った実装**: 4KB未満はDynamoDB直接保存 → **絶対にやらない！**
- ❌ **間違った実装**: TinyDBを使用 → **絶対にやらない！**
- 📝 **理由**: 
  - 統一的なバックアップとアーカイブ
  - 分析用データの一元管理
  - 監査ログとしての完全性保証
  - ストレージコストの最適化（S3の方が安価）

### 優先順位
- **BlobStorage優先**: AzureユーザーはBlobStorageを主に使用
- **S3代替**: AWSユーザーはS3を使用
- **記載順序**: ドキュメントでは「BlobStorage/S3」の順で記載

## ストレージ構成

### テナント別バケット/コンテナ
各テナントは完全に独立したストレージを保有：
- **Azure Blob**: `chat-data`（コンテナ名）
- **AWS S3**: `{tenant-id}-chat-data`（バケット名）

## ディレクトリ構造

### 完全なファイル格納構造
```
{tenant-bucket}/
├── {user_id}/
│   ├── chats/                 # チャットメッセージ
│   │   └── {room_id}/
│   │       └── yyyy/
│   │           └── mm/
│   │               └── dd/
│   │                   ├── 09-15-23.456Z-msg_001.json
│   │                   ├── 09-15-24.123Z-msg_002.json
│   │                   └── 14-30-45.789Z-msg_003.json
│   │
│   ├── uploads/               # ユーザーアップロードファイル
│   │   └── yyyy/
│   │       └── mm/
│   │           └── dd/
│   │               ├── {file_id}_{filename}
│   │               └── {file_id}_document.pdf
│   │
│   ├── generated/             # AI生成ファイル
│   │   ├── images/
│   │   │   └── yyyy/mm/dd/
│   │   │       ├── {image_id}_dalle3.png
│   │   │       └── {image_id}_generated.jpg
│   │   ├── audio/
│   │   │   └── yyyy/mm/dd/
│   │   │       └── {audio_id}_speech.mp3
│   │   └── documents/
│   │       └── yyyy/mm/dd/
│   │           └── {doc_id}_report.pdf
│   │
│   └── thumbnails/            # 画像サムネイル
│       ├── {file_id}_thumb.jpg
│       └── {image_id}_thumb.jpg
```

### パス形式の詳細

#### チャットメッセージ（1発言1ファイル）
```
{user_id}/chats/{room_id}/yyyy/mm/dd/hh-mm-ss.sssZ-msg_id.json
```
例：`user123/chats/roomA/2025/08/05/12-34-56.789Z-msg_abc123.json`

#### アップロードファイル
```
{user_id}/uploads/yyyy/mm/dd/{file_id}_{original_filename}
```
例：`user123/uploads/2025/08/05/file_xyz789_report.pdf`

#### AI生成画像
```
{user_id}/generated/images/yyyy/mm/dd/{image_id}_{type}.png
```
例：`user123/generated/images/2025/08/05/img_def456_dalle3.png`

#### サムネイル
```
{user_id}/thumbnails/{file_id}_thumb.jpg
```
例：`user123/thumbnails/file_xyz789_thumb.jpg`

## メッセージデータ形式

### JSONファイル内容
```json
{
  "message_id": "msg_abc123",
  "user_id": "user123",
  "room_id": "roomA",
  "timestamp": "2025-08-05T12:34:56.789Z",
  "role": "user",
  "content": "メッセージ本文",
  
  // オプション: RAGコンテキスト
  "context": {
    "rag_sources": [
      {
        "title": "ソースタイトル",
        "source": "internal-db",
        "text": "参照されたテキスト",
        "score": 0.95
      }
    ]
  },
  
  // オプション: 添付ファイル
  "attachments": [
    {
      "type": "image",
      "url": "https://storage.blob.core.windows.net/chat-data/user123/uploads/2025/08/05/file_xyz789_photo.jpg",
      "thumbnail": "https://storage.blob.core.windows.net/chat-data/user123/thumbnails/file_xyz789_thumb.jpg",
      "name": "photo.jpg",
      "size": 2048576
    }
  ],
  
  // オプション: 生成画像
  "generated_images": [
    {
      "url": "https://storage.blob.core.windows.net/chat-data/user123/generated/images/2025/08/05/img_def456_dalle3.png",
      "thumbnail": "https://storage.blob.core.windows.net/chat-data/user123/thumbnails/img_def456_thumb.jpg",
      "prompt": "富士山の夕焼けの風景画",
      "size": "1024x1024",
      "style": "realistic"
    }
  ],
  
  // オプション: エージェント実行情報
  "agent_info": {
    "mode": "web",
    "execution_time_ms": 1250,
    "tokens_used": 145
  }
}
```

## ファイル保存仕様

### アップロードファイルの保存
```python
async def save_upload_file(user_id: str, file_data: bytes, 
                          filename: str, content_type: str):
    """ユーザーアップロードファイルを保存"""
    from datetime import datetime
    import uuid
    
    file_id = str(uuid.uuid4())
    date_path = datetime.now().strftime("%Y/%m/%d")
    
    # ファイルパス
    file_key = f"{user_id}/uploads/{date_path}/{file_id}_{filename}"
    
    # BlobStorage/S3に保存
    result = await storage_service.upload_binary(
        key=file_key,
        data=file_data,
        content_type=content_type,
        metadata={
            'user_id': user_id,
            'original_filename': filename,
            'upload_date': datetime.now().isoformat()
        }
    )
    
    # サムネイル生成（画像の場合）
    if content_type.startswith('image/'):
        thumbnail_key = f"{user_id}/thumbnails/{file_id}_thumb.jpg"
        thumbnail_data = await generate_thumbnail(file_data)
        await storage_service.upload_binary(
            key=thumbnail_key,
            data=thumbnail_data,
            content_type='image/jpeg'
        )
        result['thumbnail_url'] = storage_service.get_url(thumbnail_key)
    
    return {
        'file_id': file_id,
        'url': result['url'],
        'thumbnail_url': result.get('thumbnail_url'),
        'size': len(file_data),
        'content_type': content_type
    }
```

### AI生成画像の保存
```python
async def save_generated_image(user_id: str, chat_id: str, 
                              image_data: bytes, prompt: str):
    """AI生成画像を保存"""
    from datetime import datetime
    import uuid
    
    image_id = str(uuid.uuid4())
    date_path = datetime.now().strftime("%Y/%m/%d")
    
    # 画像パス
    image_key = f"{user_id}/generated/images/{date_path}/{image_id}_dalle3.png"
    
    # BlobStorage/S3に保存
    result = await storage_service.upload_binary(
        key=image_key,
        data=image_data,
        content_type='image/png',
        metadata={
            'user_id': user_id,
            'chat_id': chat_id,
            'prompt': prompt,
            'generation_date': datetime.now().isoformat(),
            'generator': 'dalle3'
        }
    )
    
    # サムネイル生成
    thumbnail_key = f"{user_id}/thumbnails/{image_id}_thumb.jpg"
    thumbnail_data = await generate_thumbnail(image_data)
    await storage_service.upload_binary(
        key=thumbnail_key,
        data=thumbnail_data,
        content_type='image/jpeg'
    )
    
    return {
        'image_id': image_id,
        'url': result['url'],
        'thumbnail_url': storage_service.get_url(thumbnail_key),
        'prompt': prompt,
        'size': '1024x1024'
    }
```

## 実装例

### Python実装（メッセージ保存）
```python
async def save_message(user_id: str, chat_id: str, message: dict):
    """メッセージをBlobStorage/S3に保存"""
    import json
    from datetime import datetime
    from services.storage_service import storage_service
    
    # タイムスタンプとキーの生成
    timestamp = datetime.now()
    date_path = timestamp.strftime("%Y/%m/%d")
    time_str = timestamp.strftime("%H-%M-%S.%f")[:-3] + "Z"
    message_id = message.get('id', str(uuid.uuid4()))
    
    # ストレージキー
    storage_key = f"{user_id}/chats/{chat_id}/{date_path}/{time_str}-{message_id}.json"
    
    # メッセージデータ
    message_data = {
        "message_id": message_id,
        "user_id": user_id,
        "room_id": chat_id,
        "timestamp": timestamp.isoformat(),
        "role": message['role'],
        "content": message['content']
    }
    
    # オプションフィールドの追加
    if 'attachments' in message:
        message_data['attachments'] = message['attachments']
    if 'generated_images' in message:
        message_data['generated_images'] = message['generated_images']
    if 'context' in message:
        message_data['context'] = message['context']
    if 'agent_info' in message:
        message_data['agent_info'] = message['agent_info']
    
    # JSONとして保存
    message_json = json.dumps(message_data, ensure_ascii=False, indent=2)
    
    result = await storage_service.put_object(storage_key, message_json)
    
    if result['success']:
        print(f"メッセージを保存しました: {storage_key}")
    else:
        raise Exception(f"保存失敗: {result.get('error')}")
    
    return message_data
```

## 取得方法

### 最新メッセージの取得
```python
async def get_chat_messages(user_id: str, chat_id: str, limit: int = 50):
    """チャットメッセージを取得"""
    from services.storage_service import storage_service
    
    # プレフィックス
    prefix = f"{user_id}/chats/{chat_id}/"
    
    # オブジェクトリストを取得
    result = await storage_service.list_objects(prefix=prefix, limit=limit)
    
    messages = []
    if result.get('success') and result.get('objects'):
        # 各メッセージファイルを読み込む
        for obj in result['objects']:
            key = obj['key']
            content = await storage_service.get_object(key)
            
            if content:
                try:
                    message = json.loads(content)
                    messages.append(message)
                except json.JSONDecodeError:
                    print(f"パース失敗: {key}")
                    continue
        
        # タイムスタンプでソート（古い順）
        messages.sort(key=lambda x: x.get('timestamp', ''))
    
    return messages
```

### ユーザーのアップロードファイル一覧取得
```python
async def get_user_uploads(user_id: str, limit: int = 100):
    """ユーザーのアップロードファイル一覧を取得"""
    prefix = f"{user_id}/uploads/"
    
    result = await storage_service.list_objects(prefix=prefix, limit=limit)
    
    files = []
    if result.get('success') and result.get('objects'):
        for obj in result['objects']:
            # ファイル名から情報を抽出
            key_parts = obj['key'].split('/')
            if len(key_parts) > 0:
                filename_parts = key_parts[-1].split('_', 1)
                if len(filename_parts) == 2:
                    file_id = filename_parts[0]
                    original_name = filename_parts[1]
                    
                    files.append({
                        'file_id': file_id,
                        'filename': original_name,
                        'url': storage_service.get_url(obj['key']),
                        'size': obj.get('size', 0),
                        'last_modified': obj.get('last_modified')
                    })
    
    return files
```

## メタデータ管理

### チャットルーム情報（DynamoDB/CosmosDB）
メッセージ本体はBlobStorage/S3に保存し、チャットルーム情報のみDB管理：

```python
# チャットルーム管理のみ（メッセージインデックスは不要）
{
    'PK': f'USER#{user_id}',
    'SK': f'ROOM#{room_id}',
    'title': 'チャットタイトル',
    'created_at': '2025-08-05T10:00:00Z',
    'updated_at': '2025-08-05T12:34:56Z',
    'message_count': 42,
    'last_message': {
        'text': '最後のメッセージプレビュー...',
        'timestamp': '2025-08-05T12:34:56Z',
        'role': 'assistant'
    }
}
```

## 制限事項

### ファイルサイズ制限
- **アップロードファイル**: 最大10MB
- **生成画像**: DALL-E 3の制限に準拠（通常1024x1024）
- **サムネイル**: 最大200x200ピクセル、JPEG形式

### レート制限
- **1分あたりのメッセージ数**: 10
- **1時間あたりのメッセージ数**: 100
- **1時間あたりのファイルアップロード数**: 20

## 注意事項

### やってはいけないこと
1. **TinyDBの使用** - 開発環境でも使用禁止
2. **DynamoDBへの直接保存** - メッセージ本体は保存しない
3. **サイズによる保存先の分岐** - 全て一律BlobStorage/S3へ
4. **メッセージインデックスの作成** - 最大500件程度なので不要

### パフォーマンス考慮
- チャットルーム毎の最大メッセージ数：約500件
- 500件程度ならlist_objects + クライアントソートで十分高速
- 必要に応じてメモリキャッシュを実装

### セキュリティ
- ユーザーごとにプレフィックス`{user_id}/`でアクセス制限
- 署名付きURL/SASトークンで一時的アクセス許可
- クロステナントアクセスは完全に禁止
- アップロードファイルのウイルススキャン推奨