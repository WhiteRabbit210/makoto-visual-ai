# テナント設定型定義

## 目次

1. [概要](#概要)
2. [基本型定義](#基本型定義)
   - [TenantConfig](#tenantconfig)
   - [TenantStatus](#tenantstatus)
   - [TenantPlan](#tenantplan)
3. [認証設定](#認証設定)
   - [AuthConfig](#authconfig)
   - [AuthMode](#authmode)
   - [EntraIDConfig](#entraidconfig)
   - [CognitoConfig](#cognitoconfig)
4. [ストレージ設定](#ストレージ設定)
   - [StorageConfig](#storageconfig)
   - [AWSStorageConfig](#awsstorageconfig)
   - [AzureStorageConfig](#azurestorageconfig)
5. [機能設定](#機能設定)
   - [FeatureConfig](#featureconfig)
   - [LimitConfig](#limitconfig)
6. [API型定義](#api型定義)
   - [GetTenantConfigRequest](#gettenantconfigrequest)
   - [GetTenantConfigResponse](#gettenantconfigresponse)
   - [UpdateTenantConfigRequest](#updatetenantconfigrequest)
   - [CreateTenantRequest](#createtenantrequest)
7. [更新履歴](#更新履歴)

## 概要

MAKOTO Visual AIのマルチテナント環境におけるテナント設定の型定義。各テナントの認証方式、ストレージ設定、機能制限などを定義する。

本ドキュメントは、SaaS基盤（AWS）上で動作し、各テナントがAWSまたはAzure環境を選択できる構成を前提としている。

## 基本型定義

### TenantConfig

テナント設定の基本構造：

```typescript
interface TenantConfig {
  // 識別情報
  tenant_id: string;                    // テナントID（UUID形式）
  tenant_name: string;                  // テナント名（組織名）
  tenant_domain?: string;                // カスタムドメイン
  
  // ステータス
  status: TenantStatus;                 // テナントステータス
  plan: TenantPlan;                     // 契約プラン
  
  // 環境設定
  environment: 'aws' | 'azure';         // テナント環境
  region: string;                        // リージョン（ap-northeast-1等）
  
  // 認証設定
  auth_config: AuthConfig;              // 認証設定
  
  // ストレージ設定
  storage_config: StorageConfig;        // ストレージ設定
  
  // 機能設定
  feature_config: FeatureConfig;        // 機能設定
  limit_config: LimitConfig;            // 制限設定
  
  // 管理情報
  created_at: string;                   // 作成日時（ISO 8601）
  updated_at: string;                   // 更新日時（ISO 8601）
  created_by: string;                   // 作成者ID
  
  // メタデータ
  metadata?: Record<string, any>;       // カスタムメタデータ
}
```

### TenantStatus

テナントのステータス：

```typescript
enum TenantStatus {
  ACTIVE = 'active',                    // アクティブ
  SUSPENDED = 'suspended',              // 一時停止
  TRIAL = 'trial',                      // トライアル
  PENDING = 'pending',                  // 承認待ち
  DISABLED = 'disabled'                 // 無効化
}
```

### TenantPlan

契約プラン：

```typescript
enum TenantPlan {
  FREE = 'free',                        // 無料プラン
  STARTER = 'starter',                  // スタータープラン
  STANDARD = 'standard',                // スタンダードプラン
  PROFESSIONAL = 'professional',        // プロフェッショナルプラン
  ENTERPRISE = 'enterprise'             // エンタープライズプラン
}
```

## 認証設定

### AuthConfig

認証設定の基本構造：

```typescript
interface AuthConfig {
  auth_mode: AuthMode;                  // 認証モード
  
  // Cognito設定（auth_mode === 'cognito'の場合）
  cognito_config?: CognitoConfig;
  
  // Entra ID設定（auth_mode === 'entra_id'の場合）
  entra_id_config?: EntraIDConfig;
  
  // 共通設定
  mfa_enabled?: boolean;                // MFA有効化
  mfa_required?: boolean;               // MFA必須化
  
  // セッション設定
  session_duration_minutes?: number;    // セッション有効期間（分）
  idle_timeout_minutes?: number;        // アイドルタイムアウト（分）
  
  // パスワードポリシー
  password_policy?: {
    min_length: number;                  // 最小文字数
    require_uppercase: boolean;         // 大文字必須
    require_lowercase: boolean;         // 小文字必須
    require_numbers: boolean;           // 数字必須
    require_special_chars: boolean;     // 特殊文字必須
    password_history_count?: number;    // パスワード履歴保持数
    max_age_days?: number;              // パスワード有効期限（日）
  };
}
```

### AuthMode

認証モード：

```typescript
enum AuthMode {
  COGNITO = 'cognito',                  // AWS Cognito（標準）
  ENTRA_ID = 'entra_id'                 // Microsoft Entra ID（旧Azure AD）
}
```

### EntraIDConfig

Microsoft Entra ID（旧Azure AD）の設定：

```typescript
interface EntraIDConfig {
  // テナント情報
  azure_tenant_id: string;              // AzureテナントID
  azure_tenant_name?: string;           // Azureテナント名
  
  // アプリケーション設定
  client_id: string;                    // アプリケーションID
  client_secret_encrypted: string;      // クライアントシークレット（暗号化済み）
  
  // エンドポイント
  authority_url?: string;               // 認証局URL（デフォルト: login.microsoftonline.com）
  redirect_uri: string;                 // リダイレクトURI
  
  // スコープ設定
  scopes?: string[];                    // 要求するスコープ
  
  // グループマッピング
  group_mappings?: {
    admin_groups?: string[];             // 管理者グループID
    user_groups?: string[];              // 一般ユーザーグループID
    viewer_groups?: string[];            // 閲覧者グループID
  };
  
  // 属性マッピング
  attribute_mappings?: {
    email?: string;                      // メールアドレス属性
    name?: string;                       // 名前属性
    department?: string;                 // 部署属性
    employee_id?: string;                // 社員ID属性
  };
  
  // 同期設定
  sync_enabled?: boolean;               // ユーザー同期有効化
  sync_interval_hours?: number;         // 同期間隔（時間）
  last_sync_at?: string;                // 最終同期日時
}
```

### CognitoConfig

AWS Cognitoの設定：

```typescript
interface CognitoConfig {
  user_pool_id: string;                 // ユーザープールID
  user_pool_region: string;             // ユーザープールリージョン
  client_id: string;                    // アプリクライアントID
  
  // フェデレーション設定
  identity_pool_id?: string;            // IDプールID
  
  // カスタムドメイン
  custom_domain?: string;               // カスタム認証ドメイン
  
  // ユーザー属性
  custom_attributes?: {
    [key: string]: {
      type: 'string' | 'number' | 'datetime';
      mutable: boolean;
      required: boolean;
    };
  };
}
```

## ストレージ設定

### StorageConfig

ストレージ設定の基本構造：

```typescript
interface StorageConfig {
  storage_type: 'aws' | 'azure';        // ストレージタイプ
  
  // AWS設定
  aws_storage?: AWSStorageConfig;
  
  // Azure設定
  azure_storage?: AzureStorageConfig;
  
  // 共通設定
  encryption_enabled: boolean;          // 暗号化有効化
  versioning_enabled?: boolean;         // バージョニング有効化
  backup_enabled?: boolean;             // バックアップ有効化
  backup_retention_days?: number;       // バックアップ保持日数
}
```

### AWSStorageConfig

AWSストレージ設定：

```typescript
interface AWSStorageConfig {
  // S3設定
  s3_bucket: string;                    // S3バケット名
  s3_region: string;                    // S3リージョン
  s3_prefix?: string;                   // S3プレフィックス
  
  // DynamoDB設定
  dynamodb_table_prefix: string;        // DynamoDBテーブルプレフィックス
  dynamodb_region: string;              // DynamoDBリージョン
  
  // OpenSearch設定（ベクトル検索用）
  opensearch_domain?: string;           // OpenSearchドメイン
  opensearch_endpoint?: string;         // OpenSearchエンドポイント
  
  // アクセス設定
  iam_role_arn?: string;                // IAMロールARN（クロスアカウント用）
  kms_key_id?: string;                  // KMSキーID（暗号化用）
}
```

### AzureStorageConfig

Azureストレージ設定：

```typescript
interface AzureStorageConfig {
  // Blob Storage設定
  storage_account_name: string;         // ストレージアカウント名
  container_name: string;               // コンテナ名
  blob_prefix?: string;                 // Blobプレフィックス
  
  // CosmosDB設定
  cosmos_endpoint: string;              // CosmosDBエンドポイント
  cosmos_key_encrypted: string;         // CosmosDBキー（暗号化済み）
  cosmos_database: string;              // データベース名
  cosmos_container_prefix: string;      // コンテナプレフィックス
  
  // Cognitive Search設定（ベクトル検索用）
  search_service_name?: string;         // 検索サービス名
  search_endpoint?: string;             // 検索エンドポイント
  search_key_encrypted?: string;        // 検索キー（暗号化済み）
  
  // アクセス設定
  managed_identity_client_id?: string;  // マネージドID（クロステナント用）
}
```

## 機能設定

### FeatureConfig

機能設定：

```typescript
interface FeatureConfig {
  // チャット機能
  chat_enabled: boolean;                // チャット機能有効化
  web_search_enabled: boolean;          // Web検索有効化
  
  // 画像生成
  image_generation_enabled: boolean;    // 画像生成有効化
  image_generation_models?: string[];   // 使用可能なモデル
  
  // RAG（Retrieval-Augmented Generation）
  rag_enabled: boolean;                 // RAG機能有効化
  max_document_size_mb?: number;        // 最大ドキュメントサイズ（MB）
  supported_file_types?: string[];      // サポートファイルタイプ
  
  // エージェント
  agent_enabled: boolean;                // エージェント機能有効化
  custom_agents_enabled?: boolean;      // カスタムエージェント有効化
  
  // タスク・チェイン
  task_enabled: boolean;                // タスク管理有効化
  chain_enabled: boolean;                // チェイン機能有効化
  
  // 音声機能
  speech_to_text_enabled?: boolean;     // 音声認識有効化
  text_to_speech_enabled?: boolean;     // 音声合成有効化
  
  // カスタマイゼーション
  custom_branding?: {
    logo_url?: string;                   // ロゴURL
    primary_color?: string;              // プライマリカラー
    secondary_color?: string;            // セカンダリカラー
  };
}
```

### LimitConfig

制限設定：

```typescript
interface LimitConfig {
  // ユーザー制限
  max_users: number;                    // 最大ユーザー数
  max_concurrent_users?: number;        // 最大同時接続ユーザー数
  
  // ストレージ制限
  max_storage_gb: number;               // 最大ストレージ容量（GB）
  max_file_size_mb: number;             // 最大ファイルサイズ（MB）
  
  // API制限
  api_rate_limit_per_minute: number;    // API レート制限（回/分）
  api_rate_limit_per_day?: number;      // API レート制限（回/日）
  
  // チャット制限
  max_messages_per_day?: number;        // 1日の最大メッセージ数
  max_tokens_per_message?: number;      // メッセージあたりの最大トークン数
  max_chat_history_days?: number;       // チャット履歴保持日数
  
  // 画像生成制限
  max_images_per_day?: number;          // 1日の最大画像生成数
  max_image_resolution?: string;        // 最大画像解像度
  
  // ライブラリ制限
  max_libraries?: number;                // 最大ライブラリ数
  max_library_size_gb?: number;         // ライブラリあたりの最大サイズ（GB）
}
```

## API型定義

### GetTenantConfigRequest

テナント設定取得リクエスト：

```typescript
interface GetTenantConfigRequest {
  tenant_id: string;                    // テナントID
  include_sensitive?: boolean;          // 機密情報を含めるか（デフォルト: false）
}
```

### GetTenantConfigResponse

テナント設定取得レスポンス：

```typescript
interface GetTenantConfigResponse {
  config: TenantConfig;                 // テナント設定
  
  // 使用状況
  usage?: {
    current_users: number;               // 現在のユーザー数
    storage_used_gb: number;             // 使用ストレージ容量（GB）
    api_calls_today: number;             // 今日のAPI呼び出し数
    messages_today: number;              // 今日のメッセージ数
    images_generated_today: number;      // 今日の画像生成数
  };
  
  // ステータス
  health_status?: {
    auth_service: 'healthy' | 'degraded' | 'down';
    storage_service: 'healthy' | 'degraded' | 'down';
    api_service: 'healthy' | 'degraded' | 'down';
  };
}
```

### UpdateTenantConfigRequest

テナント設定更新リクエスト：

```typescript
interface UpdateTenantConfigRequest {
  tenant_id: string;                    // テナントID
  
  // 更新可能な項目（部分更新）
  tenant_name?: string;
  status?: TenantStatus;
  plan?: TenantPlan;
  
  auth_config?: Partial<AuthConfig>;
  storage_config?: Partial<StorageConfig>;
  feature_config?: Partial<FeatureConfig>;
  limit_config?: Partial<LimitConfig>;
  
  metadata?: Record<string, any>;
}
```

### CreateTenantRequest

テナント作成リクエスト：

```typescript
interface CreateTenantRequest {
  tenant_name: string;                  // テナント名（必須）
  tenant_domain?: string;               // カスタムドメイン
  
  environment: 'aws' | 'azure';         // 環境選択（必須）
  region: string;                        // リージョン（必須）
  
  plan: TenantPlan;                     // 契約プラン（必須）
  
  // 初期管理者
  admin_email: string;                  // 管理者メールアドレス
  admin_name: string;                   // 管理者名
  
  // オプション設定
  auth_mode?: AuthMode;                 // 認証モード（デフォルト: cognito）
  entra_id_config?: EntraIDConfig;      // Entra ID設定（auth_mode === 'entra_id'の場合）
  
  // 初期設定
  initial_users?: Array<{
    email: string;
    name: string;
    role: 'admin' | 'user' | 'viewer';
  }>;
}
```

## 更新履歴

- 2025-08-07: 初版作成
  - テナント基本設定の型定義
  - 認証設定（Cognito/Entra ID）の型定義
  - ストレージ設定（AWS/Azure）の型定義
  - 機能設定と制限設定の型定義
  - API関連の型定義