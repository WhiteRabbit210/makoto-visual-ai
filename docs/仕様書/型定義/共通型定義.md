# 共通型定義

## 目次

1. [概要](#概要)
2. [基本型](#基本型)
3. [エラーレスポンス](#エラーレスポンス)
4. [HTTPステータスコード](#httpステータスコード)
5. [バリデーションルール](#バリデーションルール)
6. [更新履歴](#更新履歴)

## 概要

MAKOTO Visual AIのすべてのAPIで共通して使用される型定義。基本的なデータ型、エラー処理、バリデーションルールを定義する。

## 基本型

```typescript
// UUID v4形式の文字列
type UUID = string;

// ISO 8601形式の日時文字列
type DateTime = string;

// メールアドレス形式の文字列
type Email = string;

// URLパス用のテナントID
type TenantId = string;

// ユーザーロール
type UserRole = "admin" | "user" | "viewer";

// ページネーション用の基本パラメータ
interface PaginationParams {
  limit?: number;   // 取得件数
  offset?: number;  // オフセット
  page?: number;    // ページ番号（offsetと排他的）
}

// ページネーションレスポンスの基本型
interface PaginationResponse {
  total: number;    // 総件数
  limit: number;    // 取得件数
  offset: number;   // オフセット
  total_pages?: number;  // 総ページ数
}

// ソート用パラメータ
interface SortParams {
  sort?: string;           // ソートフィールド
  order?: "asc" | "desc";  // ソート順
}
```

## エラーレスポンス

### 基本エラーレスポンス型

```typescript
interface ErrorResponse {
  error: string;           // エラーコード（大文字スネークケース）
  message: string;         // ユーザー向けエラーメッセージ（日本語）
  details?: any;           // エラーの詳細情報（オプション）
  timestamp?: DateTime;    // エラー発生時刻（オプション）
  request_id?: string;     // リクエストID（オプション）
}
```

### 具体的なエラー型

```typescript
// ユーザー数上限超過エラー
interface UserLimitExceededError extends ErrorResponse {
  error: "USER_LIMIT_EXCEEDED";
  details: {
    current_users: number;
    max_users: number;
  };
}

// 操作不可エラー
interface OperationNotAllowedError extends ErrorResponse {
  error: "OPERATION_NOT_ALLOWED";
  auth_mode?: "cognito" | "entra_id";
}

// バリデーションエラー
interface ValidationError extends ErrorResponse {
  error: "VALIDATION_ERROR";
  details: {
    field: string;
    reason: string;
    value?: any;
  }[];
}

// 認証エラー
interface AuthenticationError extends ErrorResponse {
  error: "AUTHENTICATION_REQUIRED" | "INVALID_TOKEN" | "TOKEN_EXPIRED";
}

// 権限エラー
interface AuthorizationError extends ErrorResponse {
  error: "INSUFFICIENT_PERMISSIONS" | "ACCESS_DENIED";
  required_role?: UserRole;
}

// リソース未発見エラー
interface NotFoundError extends ErrorResponse {
  error: "RESOURCE_NOT_FOUND";
  resource_type?: string;
  resource_id?: string;
}

// 競合エラー
interface ConflictError extends ErrorResponse {
  error: "RESOURCE_CONFLICT" | "DUPLICATE_ENTRY";
  conflicting_field?: string;
}

// レート制限エラー
interface RateLimitError extends ErrorResponse {
  error: "RATE_LIMIT_EXCEEDED";
  details: {
    limit: number;
    reset_at: DateTime;
    retry_after: number;  // 秒単位
  };
}
```

## HTTPステータスコード

```typescript
enum HttpStatus {
  // 成功
  OK = 200,                     // 成功
  CREATED = 201,                // リソース作成成功
  ACCEPTED = 202,               // 受理（非同期処理開始）
  NO_CONTENT = 204,             // 成功（レスポンスボディなし）
  
  // リダイレクト
  MOVED_PERMANENTLY = 301,       // 恒久的な移動
  FOUND = 302,                  // 一時的な移動
  NOT_MODIFIED = 304,           // 変更なし（キャッシュ利用）
  
  // クライアントエラー
  BAD_REQUEST = 400,            // 不正なリクエスト
  UNAUTHORIZED = 401,           // 認証が必要
  FORBIDDEN = 403,              // アクセス禁止
  NOT_FOUND = 404,              // リソースが見つからない
  METHOD_NOT_ALLOWED = 405,     // メソッドが許可されていない
  CONFLICT = 409,               // 競合
  GONE = 410,                   // リソースが削除済み
  UNPROCESSABLE_ENTITY = 422,   // 処理できないエンティティ
  TOO_MANY_REQUESTS = 429,      // リクエスト過多
  
  // サーバーエラー
  INTERNAL_SERVER_ERROR = 500,   // サーバー内部エラー
  NOT_IMPLEMENTED = 501,         // 未実装
  BAD_GATEWAY = 502,            // ゲートウェイエラー
  SERVICE_UNAVAILABLE = 503,     // サービス利用不可
  GATEWAY_TIMEOUT = 504,        // ゲートウェイタイムアウト
}
```

## バリデーションルール

### パスワード

```typescript
interface PasswordValidation {
  minLength: 8;                    // 最小文字数
  requireUppercase: true;          // 大文字必須
  requireLowercase: true;          // 小文字必須
  requireNumbers: true;            // 数字必須
  requireSpecialChars: true;       // 特殊文字必須
  specialChars: "!@#$%^&*()_+-=[]{}|;':\",./<>?";  // 使用可能な特殊文字
}

// パスワード検証関数の型
type ValidatePassword = (password: string) => {
  valid: boolean;
  errors?: string[];
};
```

### メールアドレス

```typescript
interface EmailValidation {
  maxLength: 254;                  // 最大文字数（RFC 5322準拠）
  pattern: RegExp;                 // 正規表現パターン
  allowSubaddress: true;           // プラスアドレス（user+tag@example.com）許可
}

// メールアドレス正規表現
const EMAIL_REGEX = /^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
```

### 名前

```typescript
interface NameValidation {
  maxLength: 100;                  // 最大文字数
  minLength: 1;                    // 最小文字数
  allowedChars: RegExp;            // 使用可能文字（日本語、英数字、一部記号）
}

// 名前用正規表現（日本語、英数字、スペース、ハイフン許可）
const NAME_REGEX = /^[a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\s\-]+$/;
```

### UUID

```typescript
interface UUIDValidation {
  version: 4;                      // UUID v4
  pattern: RegExp;                 // 正規表現パターン
}

// UUID v4正規表現
const UUID_V4_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
```

### 日時

```typescript
interface DateTimeValidation {
  format: "ISO8601";               // ISO 8601形式
  includeTimezone: true;           // タイムゾーン必須
  example: "2025-01-01T09:00:00+09:00";
}

// 日時検証関数の型
type ValidateDateTime = (datetime: string) => {
  valid: boolean;
  parsed?: Date;
  errors?: string[];
};
```

### ファイル

```typescript
interface FileValidation {
  maxSize: number;                 // 最大ファイルサイズ（バイト）
  allowedMimeTypes: string[];      // 許可するMIMEタイプ
  allowedExtensions: string[];     // 許可する拡張子
}

// 画像ファイルバリデーション
const IMAGE_VALIDATION: FileValidation = {
  maxSize: 10 * 1024 * 1024,     // 10MB
  allowedMimeTypes: ["image/jpeg", "image/png", "image/webp", "image/gif"],
  allowedExtensions: [".jpg", ".jpeg", ".png", ".webp", ".gif"]
};

// PDFファイルバリデーション
const PDF_VALIDATION: FileValidation = {
  maxSize: 50 * 1024 * 1024,     // 50MB
  allowedMimeTypes: ["application/pdf"],
  allowedExtensions: [".pdf"]
};
```

### 文字列長

```typescript
interface StringLengthValidation {
  min?: number;                    // 最小文字数
  max?: number;                    // 最大文字数
  countType: "characters" | "bytes";  // カウント方法
}

// よく使う文字列長制限
const STRING_LIMITS = {
  shortText: { max: 100 },         // 短いテキスト（タイトル等）
  mediumText: { max: 500 },        // 中程度のテキスト（説明等）
  longText: { max: 5000 },         // 長いテキスト（本文等）
  url: { max: 2048 },              // URL
  identifier: { max: 64 },         // ID等の識別子
} as const;
```

## 更新履歴

- 2025-08-05: 初版作成（基本型、エラーレスポンス、HTTPステータスコード、バリデーションルールを定義）