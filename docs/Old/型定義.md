# API型定義

## 目次

1. [概要](#概要)
2. [共通型定義](#共通型定義)
   - [基本型](#基本型)
   - [エラーレスポンス](#エラーレスポンス)
3. [認証API型定義](#認証api型定義)
   - [1. ユーザー登録](#1-ユーザー登録)
   - [2. ログイン](#2-ログイン)
   - [3. メール確認](#3-メール確認)
   - [4. 確認コード再送](#4-確認コード再送)
   - [5. トークンリフレッシュ](#5-トークンリフレッシュ)
   - [6. ログアウト](#6-ログアウト)
   - [7. ユーザー情報取得](#7-ユーザー情報取得)
   - [8. Entra ID同期](#8-entra-id同期)
   - [9. Entra IDシングルサインオン](#9-entra-idシングルサインオン)
   - [10. Entra IDユーザー一覧](#10-entra-idユーザー一覧)
4. [JWTトークン型定義](#jwtトークン型定義)
   - [IDトークン](#idトークン)
   - [アクセストークン](#アクセストークン)
5. [チャットAPI型定義](#チャットapi型定義)
   - [チャット一覧取得](#チャット一覧取得)
   - [チャット作成・メッセージ追加](#チャット作成メッセージ追加)
   - [チャットストリーミング](#チャットストリーミング)
6. [画像生成API型定義](#画像生成api型定義)
   - [画像生成](#画像生成)
7. [ライブラリ管理API型定義](#ライブラリ管理api型定義)
   - [ライブラリ一覧](#ライブラリ一覧)
   - [ライブラリ作成](#ライブラリ作成)
   - [ファイルアップロード](#ファイルアップロード)
8. [タスク管理API型定義](#タスク管理api型定義)
   - [タスク一覧](#タスク一覧)
   - [タスク作成](#タスク作成)
   - [テンプレートからタスク作成](#テンプレートからタスク作成)
   - [コメント追加](#コメント追加)
9. [エージェントAPI型定義](#エージェントapi型定義)
   - [プロンプト分析](#プロンプト分析)
10. [WebSocket型定義](#websocket型定義)
    - [接続パラメータ](#接続パラメータ)
    - [メッセージ型](#メッセージ型)
11. [HTTPステータスコード](#httpステータスコード)
12. [テナント設定型定義](#テナント設定型定義)
    - [テナント設定](#テナント設定)
13. [バリデーションルール](#バリデーションルール)
    - [パスワード](#パスワード)
    - [メールアドレス](#メールアドレス)
    - [名前](#名前)
    - [UUID](#uuid)
    - [日時](#日時)
14. [更新履歴](#更新履歴)

## 概要
MAKOTO Visual AIのすべてのAPIで使用される型定義をまとめたドキュメント。TypeScript形式で記述し、すべてのリクエスト・レスポンス・エラーの型を定義する。

## 共通型定義

### 基本型
```typescript
// UUID v4形式の文字列
type UUID = string;

// ISO 8601形式の日時文字列
type DateTime = string;

// メールアドレス形式の文字列
type Email = string;

// URLパス用のテナントID
type TenantId = string;
```

### エラーレスポンス
```typescript
interface ErrorResponse {
  error: string;           // エラーコード（大文字スネークケース）
  message: string;         // ユーザー向けエラーメッセージ（日本語）
  details?: any;           // エラーの詳細情報（オプション）
  timestamp?: DateTime;    // エラー発生時刻（オプション）
  request_id?: string;     // リクエストID（オプション）
}

// 具体的なエラー型
interface UserLimitExceededError extends ErrorResponse {
  error: "USER_LIMIT_EXCEEDED";
  details: {
    current_users: number;
    max_users: number;
  };
}

interface OperationNotAllowedError extends ErrorResponse {
  error: "OPERATION_NOT_ALLOWED";
  auth_mode?: "cognito" | "entra_id";
}
```

## 認証API型定義

### 1. ユーザー登録

#### リクエスト
```typescript
interface RegisterUserRequest {
  email: Email;
  password: string;  // 8文字以上、大文字・小文字・数字・記号を含む
  name: string;
  organization_name?: string;
}
```

#### レスポンス
```typescript
interface RegisterUserResponse {
  message: string;
  user_sub: UUID;
}
```

### 2. ログイン

#### リクエスト
```typescript
interface LoginRequest {
  email: Email;
  password: string;
}
```

#### レスポンス
```typescript
interface LoginResponse {
  access_token: string;
  id_token: string;
  refresh_token: string;
  expires_in: number;  // 秒単位
  tenant_id: TenantId;
}
```

### 3. メール確認

#### リクエスト
```typescript
interface ConfirmEmailRequest {
  email: Email;
  confirmation_code: string;  // 6桁の数字
}
```

#### レスポンス
```typescript
interface ConfirmEmailResponse {
  message: string;
}
```

### 4. 確認コード再送

#### リクエスト
```typescript
interface ResendConfirmationRequest {
  email: Email;
}
```

#### レスポンス
```typescript
interface ResendConfirmationResponse {
  message: string;
}
```

### 5. トークンリフレッシュ

#### リクエスト
```typescript
interface RefreshTokenRequest {
  refresh_token: string;
}
```

#### レスポンス
```typescript
interface RefreshTokenResponse {
  access_token: string;
  id_token: string;
  refresh_token: string;
  expires_in: number;
  tenant_id: TenantId;
}
```

### 6. ログアウト

#### リクエスト
```typescript
interface LogoutRequest {
  access_token: string;
}
```

#### レスポンス
```typescript
interface LogoutResponse {
  message: string;
}
```

### 7. ユーザー情報取得

#### レスポンス
```typescript
interface UserInfoResponse {
  user_id: UUID;
  email: Email;
  email_verified: boolean;
  name: string;
  tenant_id: TenantId;
  role: UserRole;
  organization_name?: string;
  created_at: DateTime;
  updated_at: DateTime;
}

type UserRole = "admin" | "user" | "viewer";
```

### 8. Entra ID同期

#### リクエスト
```typescript
interface EntraSyncRequest {
  sync_type: "full" | "incremental";
  dry_run?: boolean;  // デフォルト: false
}
```

#### レスポンス
```typescript
interface EntraSyncResponse {
  message: string;
  sync_results: {
    users_added: number;
    users_updated: number;
    users_disabled: number;
    total_users: number;
    sync_duration_ms: number;
  };
}
```

### 9. Entra IDシングルサインオン

#### リクエスト
```typescript
interface EntraSSORequest {
  entra_token: string;
  token_type: "saml" | "oauth2";
}
```

#### レスポンス
```typescript
interface EntraSSOResponse {
  access_token: string;
  id_token: string;
  refresh_token: string;
  expires_in: number;
  tenant_id: TenantId;
  auth_mode: "entra_id";
}
```

### 10. Entra IDユーザー一覧

#### パラメータ
```typescript
interface EntraUsersParams {
  limit?: number;   // デフォルト: 20、最大: 100
  offset?: number;  // デフォルト: 0
  search?: string;  // 検索キーワード
}
```

#### レスポンス
```typescript
interface EntraUsersResponse {
  users: EntraUser[];
  total: number;
  limit: number;
  offset: number;
}

interface EntraUser {
  user_id: UUID;
  entra_id: string;
  email: Email;
  name: string;
  department?: string;
  job_title?: string;
  enabled: boolean;
  last_sync: DateTime;
}
```

## JWTトークン型定義

### IDトークン
```typescript
interface IDToken {
  // 標準クレーム
  sub: UUID;                    // ユーザーID
  aud: string;                  // クライアントID
  iss: string;                  // 発行者URL
  exp: number;                  // 有効期限（UNIXタイムスタンプ）
  iat: number;                  // 発行時刻（UNIXタイムスタンプ）
  auth_time: number;            // 認証時刻（UNIXタイムスタンプ）
  token_use: "id";
  
  // ユーザー情報
  email: Email;
  email_verified: boolean;
  name: string;
  
  // カスタムクレーム
  "custom:tenant_id": TenantId;
  "custom:role": UserRole;
  "custom:organization_name"?: string;
  
  // グループ情報
  "cognito:groups": string[];
}
```

### アクセストークン
```typescript
interface AccessToken {
  // 標準クレーム
  sub: UUID;                    // ユーザーID
  aud: string;                  // クライアントID
  iss: string;                  // 発行者URL
  exp: number;                  // 有効期限（UNIXタイムスタンプ）
  iat: number;                  // 発行時刻（UNIXタイムスタンプ）
  token_use: "access";
  scope: string;                // スコープ（スペース区切り）
  
  // カスタムクレーム
  "custom:tenant_id": TenantId;
  "custom:role": UserRole;
  
  // グループ情報
  "cognito:groups": string[];
}
```

## チャットAPI型定義

### チャット一覧取得

#### パラメータ
```typescript
interface GetChatsParams {
  page?: number;     // デフォルト: 1
  limit?: number;    // デフォルト: 20、最大: 100
  sort?: "created_at" | "updated_at";  // デフォルト: "updated_at"
  order?: "asc" | "desc";               // デフォルト: "desc"
}
```

#### レスポンス
```typescript
interface GetChatsResponse {
  chats: Chat[];
  total: number;
  page: number;
  limit: number;
  total_pages: number;
}

interface Chat {
  id: UUID;
  title: string;
  created_at: DateTime;
  updated_at: DateTime;
  message_count: number;
  last_message?: string;
}
```

### チャット作成・メッセージ追加

#### リクエスト
```typescript
interface CreateChatRequest {
  chat_id?: UUID;        // 既存チャットに追加する場合
  message: string;
  active_modes?: ChatMode[];
}

type ChatMode = "chat" | "image" | "web" | "rag";
```

#### レスポンス
```typescript
interface CreateChatResponse {
  chat_id: UUID;
  message_id: UUID;
  title?: string;        // 新規作成時のみ
  created_at: DateTime;
}
```

### チャットストリーミング

#### リクエスト
```typescript
interface ChatStreamRequest {
  chat_id?: UUID;
  message: string;
  active_modes?: ChatMode[];
  temperature?: number;   // 0.0-1.0
  max_tokens?: number;
}
```

#### ストリーミングレスポンス（Server-Sent Events）
```typescript
// テキストチャンク
interface TextChunkEvent {
  content: string;
}

// 画像生成開始
interface ImageGeneratingEvent {
  generating_image: true;
}

// 画像生成完了
interface ImageGeneratedEvent {
  images: GeneratedImage[];
}

interface GeneratedImage {
  url: string;
  prompt: string;
  created_at: DateTime;
  size?: string;
  quality?: string;
}

// エラー
interface StreamErrorEvent {
  error?: string;
  image_error?: string;
}

// 完了
interface StreamCompleteEvent {
  done: true;
  chat_id: UUID;
  message_id?: UUID;
}
```

## 画像生成API型定義

### 画像生成

#### リクエスト
```typescript
interface GenerateImageRequest {
  prompt: string;
  n?: number;           // 生成枚数（デフォルト: 1、最大: 4）
  size?: ImageSize;     // デフォルト: "1024x1024"
  quality?: "standard" | "hd";  // デフォルト: "standard"
  output_format?: "url" | "base64";  // デフォルト: "url"
}

type ImageSize = "1024x1024" | "1792x1024" | "1024x1792";
```

#### レスポンス
```typescript
interface GenerateImageResponse {
  images: {
    url: string;
    prompt: string;
    revised_prompt?: string;  // DALL-E 3が修正したプロンプト
    created_at: DateTime;
  }[];
}
```

## ライブラリ管理API型定義

### ライブラリ一覧

#### レスポンス
```typescript
interface GetLibrariesResponse {
  libraries: Library[];
}

interface Library {
  id: UUID;
  name: string;
  description?: string;
  file_count: number;
  total_size: number;  // バイト単位
  created_at: DateTime;
  updated_at: DateTime;
}
```

### ライブラリ作成

#### リクエスト
```typescript
interface CreateLibraryRequest {
  name: string;
  description?: string;
}
```

#### レスポンス
```typescript
interface CreateLibraryResponse {
  id: UUID;
  name: string;
  description?: string;
  created_at: DateTime;
}
```

### ファイルアップロード

#### リクエスト（multipart/form-data）
```typescript
interface UploadFileRequest {
  file: File;  // アップロードするファイル
}
```

#### レスポンス
```typescript
interface UploadFileResponse {
  filename: string;
  size: number;
  mime_type: string;
  uploaded_at: DateTime;
}
```

## タスク管理API型定義

### タスク一覧

#### パラメータ
```typescript
interface GetTasksParams {
  status?: TaskStatus;
  archived?: boolean;
  limit?: number;
  offset?: number;
}

type TaskStatus = "todo" | "in_progress" | "done";
```

#### レスポンス
```typescript
interface GetTasksResponse {
  tasks: Task[];
  total: number;
}

interface Task {
  id: UUID;
  title: string;
  description?: string;
  status: TaskStatus;
  priority?: TaskPriority;
  due_date?: DateTime;
  archived: boolean;
  created_at: DateTime;
  updated_at: DateTime;
  comments_count: number;
}

type TaskPriority = "low" | "medium" | "high";
```

### タスク作成

#### リクエスト
```typescript
interface CreateTaskRequest {
  title: string;
  description?: string;
  status?: TaskStatus;     // デフォルト: "todo"
  priority?: TaskPriority; // デフォルト: "medium"
  due_date?: DateTime;
}
```

#### レスポンス
```typescript
interface CreateTaskResponse extends Task {}
```

### テンプレートからタスク作成

#### リクエスト
```typescript
interface CreateTaskFromTemplateRequest {
  template_id: UUID;
  title?: string;  // テンプレートのタイトルを上書き
  due_date?: DateTime;
}
```

### コメント追加

#### リクエスト
```typescript
interface AddCommentRequest {
  content: string;
}
```

#### レスポンス
```typescript
interface AddCommentResponse {
  id: UUID;
  task_id: UUID;
  content: string;
  created_at: DateTime;
  created_by: UUID;
}
```

## エージェントAPI型定義

### プロンプト分析

#### リクエスト
```typescript
interface AnalyzePromptRequest {
  prompt: string;
}
```

#### レスポンス
```typescript
interface AnalyzePromptResponse {
  recommended_mode: ChatMode;
  confidence: number;  // 0.0-1.0
  reasoning: string;
  alternative_modes?: {
    mode: ChatMode;
    confidence: number;
  }[];
}
```

## WebSocket型定義

### 接続パラメータ
```typescript
interface WebSocketConnectParams {
  client_id: string;
  token?: string;  // 認証トークン（オプション）
}
```

### メッセージ型
```typescript
// クライアント → サーバー
interface WebSocketMessage {
  action: "chat" | "retrieve_large_message" | "ping";
  data: any;
  request_id?: string;
}

// サーバー → クライアント
interface WebSocketResponse {
  type: "message" | "error" | "pong";
  data: any;
  request_id?: string;
}
```

## HTTPステータスコード

```typescript
enum HttpStatus {
  // 成功
  OK = 200,
  CREATED = 201,
  NO_CONTENT = 204,
  
  // クライアントエラー
  BAD_REQUEST = 400,
  UNAUTHORIZED = 401,
  FORBIDDEN = 403,
  NOT_FOUND = 404,
  CONFLICT = 409,
  UNPROCESSABLE_ENTITY = 422,
  TOO_MANY_REQUESTS = 429,
  
  // サーバーエラー
  INTERNAL_SERVER_ERROR = 500,
  NOT_IMPLEMENTED = 501,
  BAD_GATEWAY = 502,
  SERVICE_UNAVAILABLE = 503,
  GATEWAY_TIMEOUT = 504,
}
```

## テナント設定型定義

### テナント設定
```typescript
interface TenantConfig {
  tenant_id: TenantId;
  auth_mode: "cognito" | "entra_id";
  max_users: number;
  plan: "free" | "standard" | "enterprise";
  features: {
    max_storage_gb: number;
    api_rate_limit: number;
    image_generation?: boolean;
    audio_processing?: boolean;
  };
  entra_config?: EntraConfig;  // Entra ID連携時のみ
  created_at: DateTime;
  updated_at: DateTime;
}

interface EntraConfig {
  tenant_id: string;        // Microsoft テナントID
  client_id: string;        // アプリケーションID
  client_secret: string;    // クライアントシークレット
  redirect_uri: string;     // リダイレクトURI
  scope?: string[];         // 要求するスコープ
}
```

## バリデーションルール

### パスワード
- 最小8文字
- 大文字を1文字以上含む
- 小文字を1文字以上含む
- 数字を1文字以上含む
- 記号を1文字以上含む

### メールアドレス
- RFC 5322準拠
- 最大254文字

### 名前
- 最大100文字
- 空文字不可

### UUID
- UUID v4形式
- 正規表現: `/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i`

### 日時
- ISO 8601形式
- タイムゾーン付き（推奨）
- 例: `2025-01-01T09:00:00+09:00`

## 更新履歴
- 2025-08-05: 初版作成（すべてのAPIの型定義を網羅）
- 2025-08-05: TenantConfig型定義を追加