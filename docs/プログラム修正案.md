# プログラム修正案

## 目次
1. [概要](#概要)
2. [優先度高：機能修正](#優先度高機能修正)
3. [優先度中：パフォーマンス改善](#優先度中パフォーマンス改善)
4. [優先度低：リファクタリング](#優先度低リファクタリング)
5. [テスト強化](#テスト強化)
6. [実装計画](#実装計画)

## 概要

このドキュメントは、現在のコードベースを分析して発見された改善点をまとめたものです。
実際のコード変更は行わず、今後の開発の参考資料として使用してください。

## 優先度高：機能修正

### 1. ChatService の非同期処理完全対応

**現状の問題**
- `initialize_sample_data`が非同期化されたが、呼び出し元が同期的な可能性

**修正案**
```python
# main.py での呼び出しを確認
# 同期呼び出しの場合：
ChatService.initialize_sample_data()  # 現在

# 非同期呼び出しに変更：
await ChatService.initialize_sample_data()  # 修正後
```

### 2. エラーハンドリングの統一

**現状の問題**
- サービス層でのエラーハンドリングが不統一
- KVMサービスのエラーが上位層に伝播していない場合がある

**修正案**
```python
# 統一的なエラーハンドラークラスの作成
class ServiceError(Exception):
    def __init__(self, message: str, code: str, details: dict = None):
        self.message = message
        self.code = code
        self.details = details or {}
```

### 3. room_id 統一の徹底

**現状の問題**
- 一部のコードでまだ`chat_id`が残っている可能性
- フロントエンドとの整合性確認が必要

**修正案**
- 全ファイルで`chat_id`を検索し、`room_id`に置換
- APIレスポンスの互換性維持（非推奨フィールドとして`chat_id`を残す）

## 優先度中：パフォーマンス改善

### 1. KVMクエリの最適化

**現状の問題**
- `get_all_chats`で大量のデータを取得する際のパフォーマンス

**修正案**
```python
# 並列クエリの実装
async def get_all_chats_optimized():
    # GSI（グローバルセカンダリインデックス）の活用
    # ProjectionExpressionで必要なフィールドのみ取得
    # バッチ取得の実装
```

### 2. ローカルインデックスの活用強化

**現状の問題**
- TinyDBローカルインデックスが作成されたが、活用が不十分

**修正案**
```python
# ChatServiceでローカルインデックスを活用
async def get_chat_with_cache(room_id: str):
    # 1. ローカルインデックスを確認
    cached = local_index_service.get_chat_index(room_id)
    if cached and not is_expired(cached):
        return cached
    
    # 2. KVMから取得
    data = await kvm_service.get_item(...)
    
    # 3. ローカルインデックスを更新
    local_index_service.update_chat_index(room_id, data)
    
    return data
```

### 3. バッチ処理の並列化

**現状の問題**
- Parquet変換が逐次処理で時間がかかる

**修正案**
```python
# asyncio.gather()を使用した並列処理
async def process_daily_batch_parallel():
    tasks = []
    for tenant in tenants:
        for user in users:
            task = process_user_messages(tenant, user)
            tasks.append(task)
    
    # 並列実行（同時実行数を制限）
    semaphore = asyncio.Semaphore(10)
    async with semaphore:
        results = await asyncio.gather(*tasks)
```

## 優先度低：リファクタリング

### 1. サービス層の責務分離

**現状の問題**
- ChatServiceが多くの責務を持ちすぎている

**修正案**
```python
# 責務ごとにサービスを分割
- ChatService: チャット管理のみ
- MessageService: メッセージ管理
- StorageService: ストレージ操作
- IndexService: インデックス管理
```

### 2. 設定管理の改善

**現状の問題**
- 環境変数が.envファイルに直接記載
- 環境ごとの設定切り替えが困難

**修正案**
```python
# Pydantic Settingsを使用した設定管理
from pydantic import BaseSettings

class Settings(BaseSettings):
    # 環境変数から自動読み込み
    azure_openai_key: str
    azure_openai_endpoint: str
    kvm_type: str = "mock"  # デフォルト値
    
    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"

settings = Settings()
```

### 3. 型定義の強化

**現状の問題**
- 一部の関数で型ヒントが不足

**修正案**
```python
# より厳密な型定義
from typing import TypedDict, Literal

class MessageDict(TypedDict):
    id: str
    room_id: str
    role: Literal["user", "assistant", "system"]
    content: str
    timestamp: str
```

## テスト強化

### 1. 単体テストの追加

**必要なテスト**
- KVMサービスの各メソッド
- バッチ処理の各ステップ
- ローカルインデックスの操作

**テストファイル構成案**
```
tests/
├── unit/
│   ├── test_kvm_service.py
│   ├── test_batch_processor.py
│   └── test_local_index.py
├── integration/
│   ├── test_chat_flow.py
│   └── test_storage_integration.py
└── e2e/
    └── test_full_workflow.py
```

### 2. モックの改善

**現状の問題**
- MockKVMServiceが簡易的すぎる

**修正案**
```python
class ImprovedMockKVMService:
    def __init__(self):
        self.data = {}
        self.call_history = []  # API呼び出し履歴
        self.latency_simulation = False  # レイテンシシミュレーション
    
    async def query(self, ...):
        # より現実的な動作をシミュレート
        if self.latency_simulation:
            await asyncio.sleep(0.1)  # 100ms遅延
        
        # 呼び出し履歴を記録
        self.call_history.append({
            'method': 'query',
            'params': {...},
            'timestamp': datetime.now()
        })
```

### 3. パフォーマンステスト

**追加すべきテスト**
```python
# tests/performance/test_load.py
async def test_concurrent_users():
    """同時アクセステスト"""
    users = 100
    tasks = []
    for i in range(users):
        task = ChatService.get_all_chats(user_id=f"user_{i}")
        tasks.append(task)
    
    start = time.time()
    results = await asyncio.gather(*tasks)
    duration = time.time() - start
    
    assert duration < 10  # 10秒以内
    assert all(r['success'] for r in results)
```

## 実装計画

### Phase 1: 緊急修正（1週間）
1. room_id統一の完全実施
2. エラーハンドリングの改善
3. 非同期処理の修正

### Phase 2: パフォーマンス改善（2週間）
1. KVMクエリ最適化
2. ローカルインデックス活用
3. バッチ処理並列化

### Phase 3: 品質向上（3週間）
1. テストカバレッジ80%達成
2. リファクタリング実施
3. ドキュメント更新

### Phase 4: 本番準備（2週間）
1. 負荷テスト実施
2. セキュリティ監査
3. デプロイメント自動化

## 実装時の注意事項

### 後方互換性の維持
- APIレスポンスは既存フィールドを削除しない
- 非推奨フィールドは`deprecated`マークを付ける
- 移行期間を設ける（最低3ヶ月）

### 段階的な移行
- カナリアデプロイメントを使用
- フィーチャーフラグで新機能を制御
- ロールバック計画を準備

### モニタリング強化
- 各修正後のメトリクス監視
- エラー率の追跡
- パフォーマンス指標の記録

## リスクと対策

### リスク1: データ不整合
**対策**: 
- マイグレーションスクリプトの作成
- バックアップの実施
- ロールバック手順の文書化

### リスク2: パフォーマンス劣化
**対策**:
- 段階的なリリース
- A/Bテストの実施
- パフォーマンステストの自動化

### リスク3: 互換性の破壊
**対策**:
- APIバージョニング
- 非推奨警告の実装
- 移行ガイドの作成

---

**作成者**: Claude  
**作成日**: 2025年8月12日  
**ステータス**: 提案  
**レビュー予定**: 未定

## 付録：チェックリスト

### コードレビュー時の確認項目
- [ ] room_idに統一されているか
- [ ] エラーハンドリングが適切か
- [ ] 非同期処理が正しく実装されているか
- [ ] 型定義が正確か
- [ ] テストが追加されているか
- [ ] ドキュメントが更新されているか
- [ ] パフォーマンスへの影響を考慮したか
- [ ] セキュリティリスクはないか
- [ ] ログが適切に出力されるか
- [ ] 設定値が環境変数から取得されているか